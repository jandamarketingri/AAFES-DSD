<!DOCTYPE html>
<html>
<head>
    <title>Apparel Products</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2196F3;
            text-decoration: none;
            font-size: 16px;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        #headerForm {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto 30px auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #2196F3;
        }
        .form-group input.valid {
            border-color: #4CAF50;
            background-color: #f1f8f4;
        }
        .form-group input.invalid {
            border-color: #f44336;
            background-color: #ffebee;
        }
        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }
        .validation-message.success {
            color: #4CAF50;
        }
        .validation-message.error {
            color: #f44336;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }
        .checkbox-group input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .checkbox-group label {
            font-weight: 600;
            color: #333;
            cursor: pointer;
            margin: 0;
            transition: opacity 0.3s;
        }
        .filter-section {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto 20px auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .filter-btn.men-category {
            background-color: #E3F2FD;
            border-color: #90CAF9;
        }
        .filter-btn.women-category {
            background-color: #FCE4EC;
            border-color: #F48FB1;
        }
        .filter-btn:hover {
            border-color: #333;
            border-width: 3px;
        }
        .filter-btn.active {
            border-color: #333;
            border-width: 3px;
            font-weight: 700;
        }
        .search-section {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto 30px auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        .search-bar input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .clear-search-btn {
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .clear-search-btn:hover {
            background-color: #da190b;
        }
        .search-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        .cart-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s;
        }
        .cart-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        .cart-badge {
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        #skuContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 100px;
        }
        .sku-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .sku-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .sku-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        .product-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .product-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        .sku-category {
            display: inline-block;
            background-color: #f0f0f0;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        .image-gallery {
            margin: 15px 0;
            position: relative;
        }
        .main-image {
            width: 100%;
            height: 250px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .thumbnail-container {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: border-color 0.3s;
            background-color: #f9f9f9;
        }
        .thumbnail:hover {
            border-color: #4CAF50;
        }
        .thumbnail.active {
            border-color: #4CAF50;
        }
        
        /* NEW: Size Grid Styles */
        .size-grid-section {
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        .size-grid-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-fill-btns {
            display: flex;
            gap: 5px;
        }
        .quick-fill-btn {
            padding: 4px 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.3s;
        }
        .quick-fill-btn:hover {
            background-color: #1976D2;
        }
        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        .size-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .size-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .size-qty-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            transition: border-color 0.3s;
        }
        .size-qty-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .size-qty-input:not([value="0"]) {
            border-color: #4CAF50;
            background-color: #f1f8f4;
        }
        .total-qty-display {
            margin-top: 12px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .add-to-cart-btn {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .add-to-cart-btn:hover {
            background-color: #45a049;
        }
        .add-to-cart-btn:active {
            transform: scale(0.98);
        }
        .add-to-cart-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .cart-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .cart-header h3 {
            margin: 0;
            color: #333;
        }
        .close-cart {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .cart-item-info {
            flex: 1;
        }
        .cart-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }
        .cart-item-sku {
            font-size: 13px;
            color: #2196F3;
            margin-bottom: 3px;
        }
        .cart-item-size {
            font-size: 13px;
            color: #666;
        }
        .cart-item-qty {
            font-size: 14px;
            color: #333;
            margin-right: 15px;
        }
        .remove-item {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .remove-item:hover {
            background-color: #da190b;
        }
        .cart-empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .cart-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .cart-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .clear-cart-btn {
            background-color: #f44336;
            color: white;
        }
        .submit-order-btn {
            background-color: #4CAF50;
            color: white;
        }
        .loading {
            text-align: center;
            font-size: 18px;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        .error {
            text-align: center;
            font-size: 16px;
            color: #f44336;
            padding: 20px;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<a href="index.html" class="back-link">‚Üê Back to Main Menu</a>

<h2>üëï Apparel Products</h2>

<div id="headerForm">
    <div class="form-row">
        <div class="form-group">
            <label for="repName">Sales Rep Name *</label>
            <input type="text" id="repName" placeholder="Enter your name" required>
        </div>
        <div class="form-group">
            <label for="repEmail">Email Address *</label>
            <input type="email" id="repEmail" placeholder="Enter your email" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="facilityId">Facility ID *</label>
            <input type="text" id="facilityId" placeholder="7-digit ID" maxlength="7" required>
            <div id="facilityValidation" class="validation-message"></div>
        </div>
        <div class="form-group">
            <label for="locationName">Location Name *</label>
            <input type="text" id="locationName" placeholder="Enter location name" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="beginShipDate">Begin Ship Date *</label>
            <input type="date" id="beginShipDate" required>
        </div>
        <div class="form-group">
            <label for="shipByDate">Ship By Date *</label>
            <input type="date" id="shipByDate" required>
        </div>
    </div>
    <div class="form-row">
        <div class="checkbox-group">
            <input type="checkbox" id="includeDisplay" disabled>
            <label for="includeDisplay">Include Display in Order (Minimum 72 pieces required)</label>
        </div>
    </div>
</div>

<div class="filter-section">
    <div class="filter-buttons">
        <button class="filter-btn men-category active" data-filter="men-basic-tees" onclick="loadCategory('men-basic-tees')">Men's Basic Tees</button>
        <button class="filter-btn men-category" data-filter="men-premium-tees" onclick="loadCategory('men-premium-tees')">Men's Premium Tees</button>
        <button class="filter-btn men-category" data-filter="men-long-sleeve" onclick="loadCategory('men-long-sleeve')">Long-Sleeve</button>
        <button class="filter-btn men-category" data-filter="men-hoodies" onclick="loadCategory('men-hoodies')">Men's Hoodies</button>
        <button class="filter-btn men-category" data-filter="men-adjustable-caps" onclick="loadCategory('men-adjustable-caps')">Adjustable Caps</button>
        <button class="filter-btn men-category" data-filter="men-elevated-caps" onclick="loadCategory('men-elevated-caps')">Elevated Caps</button>
        <button class="filter-btn women-category" data-filter="women-basic-tees" onclick="loadCategory('women-basic-tees')">Women's Basic Tees</button>
        <button class="filter-btn women-category" data-filter="women-premium-tees" onclick="loadCategory('women-premium-tees')">Women's Premium Tees</button>
        <button class="filter-btn women-category" data-filter="women-hoodies" onclick="loadCategory('women-hoodies')">Women's Hoodies</button>
        <button class="filter-btn women-category" data-filter="women-caps" onclick="loadCategory('women-caps')">Women's Caps</button>
    </div>
</div>

<div class="search-section">
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç Search by product name, SKU, description, or keywords (e.g., Army, Vet, Patriotic)...">
        <button class="clear-search-btn" onclick="clearSearch()">Clear</button>
    </div>
    <div class="search-info">Showing all products</div>
</div>

<div id="skuContainer">
    <div class="loading">Loading products...</div>
</div>

<button class="cart-button">
    üõí Cart <span class="cart-badge" style="display:none;">0</span>
</button>

<div class="cart-modal">
    <div class="cart-content">
        <div class="cart-header">
            <h3>Shopping Cart</h3>
            <button class="close-cart">&times;</button>
        </div>
        <div id="cartItems"></div>
        <div class="cart-actions">
            <button class="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
            <button class="submit-order-btn" onclick="submitOrder()">Submit Order</button>
        </div>
    </div>
</div>

<script>
var SHEET_CONFIG = {
    'men-basic-tees': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1158681494&single=true&output=csv',
    'men-premium-tees': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1204262144&single=true&output=csv',
    'men-long-sleeve': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=43873537&single=true&output=csv',
    'men-hoodies': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1525521266&single=true&output=csv',
    'men-adjustable-caps': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1177199316&single=true&output=csv',
    'men-elevated-caps': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=836123421&single=true&output=csv',
    'women-basic-tees': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1079165482&single=true&output=csv',
    'women-premium-tees': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=1288881911&single=true&output=csv',
    'women-hoodies': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=41894503&single=true&output=csv',
    'women-caps': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkzzgPIkLzN8SY8g_rwU3gK7YwJbsRMYdFtnIYw2qEFja87-1GXaKgyObGMQyJTQrotJv1GofRuqj/pub?gid=2069152279&single=true&output=csv'
};
    
var ORDER_SUBMISSION_URL = 'https://script.google.com/macros/s/AKfycbyt75krYE3h9lJl-4uR7ymSmaf3sHPGSo8pOB5TlkUgkHFPGi-Z1FlHS6Jk850g2wxS/exec';
var FACILITY_LOOKUP_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJ6i27Lw8VuJErCS4v1TUXrO6PQvoY2Dg26Esk48Lry9K0lwLab3hfchOxdeB90OCJy2jdJ1hdnnT0/pub?gid=0&single=true&output=csv';

var cart = [];
var currentCategory = 'men-basic-tees';
var currentProducts = [];
var allCategoryProducts = [];
var searchTerm = '';
var facilityData = {};

function checkAuthentication() {
    var authData = sessionStorage.getItem('salesPortalAuth');
    
    if(!authData){
        window.location.href = 'login.html';
        return;
    }
    
    try {
        var auth = JSON.parse(authData);
        $('#repName').val(auth.name).prop('readonly', true);
        $('#repEmail').val(auth.email).prop('readonly', true);
        
        $('#headerForm').prepend(
            '<div style="background:#d4edda;border:1px solid #c3e6cb;padding:12px;margin-bottom:15px;border-radius:4px;display:flex;justify-content:space-between;align-items:center;">' +
            '<div><strong>‚úì Authenticated:</strong> ' + auth.name + ' (' + auth.email + ')</div>' +
            '<button onclick="logout()" style="background:#dc3545;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;">Logout</button>' +
            '</div>'
        );
    } catch(e){
        console.error('Auth parse error:', e);
        sessionStorage.removeItem('salesPortalAuth');
        window.location.href = 'login.html';
    }
}

function logout() {
    if(confirm('Are you sure you want to log out?')){
        sessionStorage.removeItem('salesPortalAuth');
        window.location.href = 'login.html';
    }
}
    
$(document).ready(function(){
    checkAuthentication();
    loadCategory(currentCategory);
    loadFacilityData();
    
    $('#includeDisplay').prop('disabled', true);
    $('#includeDisplay').closest('.checkbox-group').find('label').css('opacity', '0.5');
    
    $('.cart-button').click(function(){ openCart(); });
    $('.close-cart').click(function(){ closeCart(); });
    $('.cart-modal').click(function(e){ if(e.target === this) closeCart(); });
    
    $('#searchInput').on('input', function(){
        searchTerm = $(this).val().toLowerCase().trim();
        filterAndDisplayProducts();
    });
    
    $('#facilityId').on('input', function(){
        var facilityId = $(this).val().trim();
        var $input = $(this);
        var $validation = $('#facilityValidation');
        var $locationName = $('#locationName');
        
        if(facilityId.length === 0){
            $input.removeClass('valid invalid');
            $validation.html('').removeClass('success error');
            $locationName.val('');
        } else if(facilityId.length === 7){
            if(facilityData[facilityId]){
                $input.removeClass('invalid').addClass('valid');
                $validation.html('‚úì Facility found: ' + facilityData[facilityId]).removeClass('error').addClass('success');
                $locationName.val(facilityData[facilityId]);
            } else {
                $input.removeClass('valid').addClass('invalid');
                $validation.html('‚ö† WARNING: Facility ID not found in database').removeClass('success').addClass('error');
                $locationName.val('');
            }
        } else {
            $input.removeClass('valid invalid');
            $validation.html('Enter 7-digit facility ID').removeClass('success error');
            $locationName.val('');
        }
    });
});

function parseCSVRow(row) {
    var cols = [];
    var current = '';
    var inQuotes = false;
    
    for(var i = 0; i < row.length; i++){
        var char = row[i];
        if(char === '"'){
            inQuotes = !inQuotes;
        } else if(char === ',' && !inQuotes){
            cols.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    cols.push(current.trim());
    return cols;
}
    
function loadCategory(category) {
    currentCategory = category;
    searchTerm = '';
    $('#searchInput').val('');
    $('.filter-btn').removeClass('active');
    $('[data-filter="' + category + '"]').addClass('active');
    
    var sheetUrl = SHEET_CONFIG[category];
    if(!sheetUrl || sheetUrl.includes('YOUR_SHEET_ID')){
        $('#skuContainer').html('<div class="error">Please configure the Google Sheet URL for this category.</div>');
        return;
    }
    
    $('#skuContainer').html('<div class="loading">Loading products...</div>');
    
    $.ajax({
        url: sheetUrl,
        method: 'GET',
        dataType: 'text',
        success: function(data){ parseProducts(data, category); },
        error: function(xhr, status, error){ 
            $('#skuContainer').html('<div class="error">Error loading data.<br><br>Common issues:<br>1. Sheet must be published to web<br>2. Sheet must be publicly viewable<br>3. URL must be CSV export format</div>'); 
        }
    });
}

function loadFacilityData() {
    $.ajax({
        url: FACILITY_LOOKUP_URL,
        method: 'GET',
        dataType: 'text',
        success: function(data){
            var rows = data.split('\n');
            facilityData = {};
            for(var i = 1; i < rows.length; i++){
                if(rows[i].trim()){
                    var cols = rows[i].split(',');
                    var facilityId = cols[0] ? cols[0].trim() : '';
                    var baseName = cols[2] ? cols[2].trim() : '';
                    if(facilityId && baseName){
                        facilityData[facilityId] = baseName;
                    }
                }
            }
        },
        error: function(){
            console.warn('Could not load facility data');
        }
    });
}

function parseProducts(csvData, category) {
    var rows = csvData.split('\n');
    allCategoryProducts = [];
    
    for(var i = 1; i < rows.length; i++){
        if(rows[i].trim()){
            var cols = parseCSVRow(rows[i]);
            if(cols.length > 0 && cols[0].trim()){
                var productName = cols[0] ? cols[0].trim() : '';
                if(productName.toUpperCase().startsWith('OUT')){
                    continue;
                }
                
                var product = {
                    name: productName,
                    description: cols[1] ? cols[1].trim() : '',
                    images: [cols[2] ? cols[2].trim() : '', cols[3] ? cols[3].trim() : '', cols[4] ? cols[4].trim() : ''].filter(img => img),
                    category: category,
                    isCap: category.includes('caps'),
                    baseSKU: productName,
                    sizes: {},
                    keywords: ''
                };
                
                if(product.isCap){
                    product.sizes['OS'] = cols[5] ? cols[5].trim() : '';
                    product.keywords = cols[6] ? cols[6].trim().toLowerCase() : '';
                } else {
                    if(cols[5] && cols[5].trim()) product.sizes['S'] = cols[5].trim();
                    if(cols[6] && cols[6].trim()) product.sizes['M'] = cols[6].trim();
                    if(cols[7] && cols[7].trim()) product.sizes['L'] = cols[7].trim();
                    if(cols[8] && cols[8].trim()) product.sizes['XL'] = cols[8].trim();
                    if(cols[9] && cols[9].trim()) product.sizes['2XL'] = cols[9].trim();
                    if(cols[10] && cols[10].trim()) product.sizes['3XL'] = cols[10].trim();
                    product.keywords = cols[11] ? cols[11].trim().toLowerCase() : '';
                }
                
                product.searchText = [
                    product.name,
                    product.description,
                    product.keywords,
                    Object.values(product.sizes).join(' ')
                ].join(' ').toLowerCase();
                
                allCategoryProducts.push(product);
            }
        }
    }
    filterAndDisplayProducts();
}

function filterAndDisplayProducts() {
    if(searchTerm === ''){
        currentProducts = allCategoryProducts;
    } else {
        currentProducts = allCategoryProducts.filter(function(product){
            return product.searchText.includes(searchTerm);
        });
    }
    displayProducts();
    updateSearchInfo();
}

function updateSearchInfo() {
    if(searchTerm === ''){
        $('.search-info').html('Showing all ' + currentProducts.length + ' products');
    } else {
        $('.search-info').html('Found ' + currentProducts.length + ' product(s) matching "' + searchTerm + '"');
    }
}

function clearSearch() {
    searchTerm = '';
    $('#searchInput').val('');
    filterAndDisplayProducts();
}

function getCategoryLabel(category) {
    var labels = {
        "men-basic-tees": "Men's Basic Tees", "men-premium-tees": "Men's Premium Tees",
        "men-long-sleeve": "Men's Long-Sleeve", "men-hoodies": "Men's Hoodies",
        "men-adjustable-caps": "Men's Adjustable Caps", "men-elevated-caps": "Men's Elevated Caps",
        "women-basic-tees": "Women's Basic Tees", "women-premium-tees": "Women's Premium Tees",
        "women-hoodies": "Women's Hoodies", "women-caps": "Women's Caps"
    };
    return labels[category] || "Products";
}

function displayProducts() {
    var html = '';
    if(currentProducts.length === 0){
        html = searchTerm === '' ? '<div class="error">No products available.</div>' : '<div class="error">No products match your search.</div>';
    } else {
        currentProducts.forEach(function(product, index){
            html += '<div class="sku-card"><div class="sku-header">';
            html += '<div class="product-name">' + product.name + '</div>';
            html += '<div class="product-description">' + product.description + '</div>';
            html += '<span class="sku-category">' + getCategoryLabel(product.category) + '</span></div>';
            
            if(product.images.length > 0){
                html += '<div class="image-gallery">';
                html += '<img src="' + product.images[0] + '" class="main-image" id="main-img-' + index + '">';
                if(product.images.length > 1){
                    html += '<div class="thumbnail-container">';
                    product.images.forEach(function(img, imgIndex){
                        html += '<img src="' + img + '" class="thumbnail ' + (imgIndex === 0 ? 'active' : '') + '" onclick="changeImage(' + index + ', ' + imgIndex + ')" data-index="' + imgIndex + '">';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }
            
            var isOneSize = (Object.keys(product.sizes).length === 1 && product.sizes['OS']);
            
            if(isOneSize){
                html += '<div class="size-grid-section">';
                html += '<div class="size-grid-header">One Size Fits All</div>';
                html += '<input type="number" class="size-qty-input" id="qty-' + index + '-OS" value="0" min="0" oninput="updateProductTotal(' + index + ')">';
                html += '<div class="total-qty-display" id="total-' + index + '">Total: 0 pieces</div>';
                html += '</div>';
            } else {
                html += '<div class="size-grid-section">';
                html += '<div class="size-grid-header">';
                html += 'Select Quantities';
                html += '<div class="quick-fill-btns">';
                html += '<button class="quick-fill-btn" onclick="quickFill(' + index + ', \'bell\')">Bell Curve</button>';
                html += '<button class="quick-fill-btn" onclick="quickFill(' + index + ', \'equal\')">Equal</button>';
                html += '<button class="quick-fill-btn" onclick="clearSizes(' + index + ')">Clear</button>';
                html += '</div></div>';
                html += '<div class="size-grid">';
                
                var sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
                sizeOrder.forEach(function(size){
                    if(product.sizes[size]){
                        html += '<div class="size-item">';
                        html += '<div class="size-label">' + size + '</div>';
                        html += '<input type="number" class="size-qty-input" id="qty-' + index + '-' + size + '" value="0" min="0" oninput="updateProductTotal(' + index + ')">';
                        html += '</div>';
                    }
                });
                
                html += '</div>';
                html += '<div class="total-qty-display" id="total-' + index + '">Total: 0 pieces</div>';
                html += '</div>';
            }
            
            html += '<button class="add-to-cart-btn" id="add-btn-' + index + '" onclick="addToCart(' + index + ')">Add to Cart</button></div>';
        });
    }
    $('#skuContainer').html(html);
}

function changeImage(productIndex, imageIndex) {
    var product = currentProducts[productIndex];
    $('#main-img-' + productIndex).attr('src', product.images[imageIndex]);
    $('#main-img-' + productIndex).closest('.image-gallery').find('.thumbnail').removeClass('active');
    $('#main-img-' + productIndex).closest('.image-gallery').find('.thumbnail[data-index="' + imageIndex + '"]').addClass('active');
}

function quickFill(productIndex, pattern) {
    var product = currentProducts[productIndex];
    var sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
    
    if(pattern === 'bell'){
        var bellCurve = {'S': 4, 'M': 6, 'L': 8, 'XL': 8, '2XL': 6, '3XL': 0};
        sizeOrder.forEach(function(size){
            if(product.sizes[size]){
                $('#qty-' + productIndex + '-' + size).val(bellCurve[size] || 0);
            }
        });
    } else if(pattern === 'equal'){
        var equalQty = 6;
        sizeOrder.forEach(function(size){
            if(product.sizes[size]){
                $('#qty-' + productIndex + '-' + size).val(equalQty);
            }
        });
    }
    
    updateProductTotal(productIndex);
}

function clearSizes(productIndex) {
    var product = currentProducts[productIndex];
    var sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
    
    sizeOrder.forEach(function(size){
        if(product.sizes[size]){
            $('#qty-' + productIndex + '-' + size).val(0);
        }
    });
    
    updateProductTotal(productIndex);
}

function updateProductTotal(productIndex) {
    var product = currentProducts[productIndex];
    var total = 0;
    
    if(product.isCap){
        total = parseInt($('#qty-' + productIndex + '-OS').val()) || 0;
    } else {
        var sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
        sizeOrder.forEach(function(size){
            if(product.sizes[size]){
                total += parseInt($('#qty-' + productIndex + '-' + size).val()) || 0;
            }
        });
    }
    
    $('#total-' + productIndex).text('Total: ' + total + ' pieces');
}

function addToCart(index) {
    var product = currentProducts[index];
    var addedAny = false;
    
    if(product.isCap){
        var qty = parseInt($('#qty-' + index + '-OS').val()) || 0;
        if(qty > 0){
            var sku = product.sizes['OS'];
            var existingIndex = cart.findIndex(item => item.sku === sku);
            if(existingIndex !== -1){
                cart[existingIndex].quantity += qty;
            } else {
                cart.push({ 
                    productName: product.name, 
                    sku: sku, 
                    size: 'OS', 
                    quantity: qty,
                    category: product.category
                });
            }
            addedAny = true;
        }
    } else {
        var sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL'];
        sizeOrder.forEach(function(size){
            if(product.sizes[size]){
                var qty = parseInt($('#qty-' + index + '-' + size).val()) || 0;
                if(qty > 0){
                    var sku = product.sizes[size];
                    var existingIndex = cart.findIndex(item => item.sku === sku);
                    if(existingIndex !== -1){
                        cart[existingIndex].quantity += qty;
                    } else {
                        cart.push({ 
                            productName: product.name, 
                            sku: sku, 
                            size: size, 
                            quantity: qty,
                            category: product.category
                        });
                    }
                    addedAny = true;
                }
            }
        });
    }
    
    if(addedAny){
        updateCartBadge();
        
        var btn = $('#add-btn-' + index);
        var originalText = btn.text();
        btn.text('Added to Cart!').css('background-color', '#45a049');
        setTimeout(function(){ 
            btn.text(originalText).css('background-color', ''); 
        }, 1500);
    } else {
        alert('Please enter at least one quantity before adding to cart.');
    }
}

function updateCartBadge() {
    var totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    totalItems > 0 ? $('.cart-badge').text(totalItems).show() : $('.cart-badge').hide();
    
    if(totalItems >= 72) {
        $('#includeDisplay').prop('disabled', false);
        $('#includeDisplay').closest('.checkbox-group').find('label').css('opacity', '1');
    } else {
        $('#includeDisplay').prop('disabled', true).prop('checked', false);
        $('#includeDisplay').closest('.checkbox-group').find('label').css('opacity', '0.5');
    }
}

function openCart() {
    displayCart();
    $('.cart-modal').fadeIn(300);
}

function closeCart() {
    $('.cart-modal').fadeOut(300);
}

function displayCart() {
    var html = '';
    if(cart.length === 0){
        html = '<div class="cart-empty">Your cart is empty</div>';
    } else {
        cart.forEach(function(item, index){
            html += '<div class="cart-item"><div class="cart-item-info">';
            html += '<div class="cart-item-name">' + item.productName + '</div>';
            html += '<div class="cart-item-sku">SKU: ' + item.sku + '</div>';
            html += '<div class="cart-item-size">Size: ' + item.size + '</div></div>';
            html += '<div class="cart-item-qty">Qty: ' + item.quantity + '</div>';
            html += '<button class="remove-item" onclick="removeFromCart(' + index + ')">Remove</button></div>';
        });
    }
    $('#cartItems').html(html);
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartBadge();
    displayCart();
}

function clearCart() {
    if(confirm('Are you sure you want to clear the cart?')){
        cart = [];
        updateCartBadge();
        displayCart();
    }
}

function submitOrder() {
    if(!$('#repName').val() || !$('#repEmail').val() || !$('#facilityId').val() || 
       !$('#locationName').val() || !$('#beginShipDate').val() || !$('#shipByDate').val()){
        alert('Please fill out all required header fields before submitting.');
        closeCart();
        return;
    }
    
    var facilityId = $('#facilityId').val().trim();
    if(facilityId.length === 7 && !facilityData[facilityId]){
        alert('‚ö† WARNING: The Facility ID you entered is not in our database.\n\nPlease verify the ID is correct before proceeding.\n\nIf this is a new facility, contact your administrator to have it added to the system.');
        closeCart();
        return;
    }
    
    if(cart.length === 0){ alert('Your cart is empty!'); return; }
    
    var authData = JSON.parse(sessionStorage.getItem('salesPortalAuth'));
    
    var orderData = {
        repName: $('#repName').val(),
        repEmail: $('#repEmail').val(),
        facilityId: $('#facilityId').val(),
        locationName: $('#locationName').val(),
        beginShipDate: $('#beginShipDate').val(),
        shipByDate: $('#shipByDate').val(),
        includeDisplay: $('#includeDisplay').is(':checked'),
        orderDate: new Date().toISOString(),
        accessCode: authData.accessCode,
        items: cart
    };
    
    $('.submit-order-btn').prop('disabled', true).text('Submitting...');
    
    var form = $('<form>', {
        method: 'POST',
        action: ORDER_SUBMISSION_URL,
        target: '_blank',
        style: 'display:none;'
    });
    
    form.append($('<input>', {
        type: 'hidden',
        name: 'data',
        value: JSON.stringify(orderData)
    }));
    
    $('body').append(form);
    form.submit();
    
    setTimeout(function() {
        form.remove();
    }, 1000);
    
    alert('üì§ Order submitted! A new window will open showing the confirmation.\n\nTotal items: ' + cart.reduce((sum, item) => sum + item.quantity, 0));
    
    cart = [];
    updateCartBadge();
    closeCart();
    
    $('.submit-order-btn').prop('disabled', false).text('Submit Order');
}
</script>

</body>
</html>
